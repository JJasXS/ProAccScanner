@page
@model FirebirdWeb.Pages.ScannerModel

<link rel="stylesheet" href="~/css/scanner.css" />

<h2>Scanner</h2>

<div class="scanner-container">
    <video id="scanner-video" autoplay playsinline style="width:100%; max-height:300px;"></video>

    <button id="start-scanner">Start Scanner</button>

    <p id="scan-result"></p>
</div>

<div class="info-section">
    <label>Scanned Location</label>
    <input type="text" id="location" readonly />

    <div id="location-confirm">
        <p>Is this location correct?</p>
        <button type="button" id="yes-btn">Yes</button>
        <button type="button" id="no-btn">No</button>
    </div>

    <div id="manual-location-container" style="display:none;">
        <label>Enter Correct Location</label>
        <input type="text" id="manual-location" />
    </div>

    <button id="update-btn" disabled>Update</button>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        const startBtn = document.getElementById('start-scanner');
        const video = document.getElementById('scanner-video');
        const scanResult = document.getElementById('scan-result');
        const locationInput = document.getElementById('location');
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');
        const manualContainer = document.getElementById('manual-location-container');
        const manualInput = document.getElementById('manual-location');
        const updateBtn = document.getElementById('update-btn');

        let scannerActive = false;
        let stream = null;

        startBtn.addEventListener('click', async () => {
    if (!scannerActive) {
        // Show the video first
        video.style.display = "block";   // ðŸ‘ˆ add this
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });

        video.srcObject = stream;
        await video.play();

        Quagga.init({
            inputStream: {
                type: "LiveStream",
                target: video
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader"]
            }
        }, () => Quagga.start());

        scannerActive = true;
        startBtn.innerText = "Stop Scanner";
    } else {
        stream.getTracks().forEach(t => t.stop());
        Quagga.stop();
        scannerActive = false;
        startBtn.innerText = "Start Scanner";

        // Hide video again when stopping
        video.style.display = "none";   // ðŸ‘ˆ optional
    }
});

        Quagga.onDetected(result => {
            scanResult.innerText = "Scanned: " + result.codeResult.code;
            locationInput.value = "Warehouse A";
            updateBtn.disabled = true;
            startBtn.click();
        });

        yesBtn.onclick = () => updateBtn.disabled = false;
        noBtn.onclick = () => manualContainer.style.display = "block";
        manualInput.oninput = () => updateBtn.disabled = !manualInput.value.trim();
    </script>
}
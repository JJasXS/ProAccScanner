@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

<div class="scanner-page">
    <h2>Scanner</h2>

    <!-- Camera / Barcode Scanner -->
    <div class="scanner-container">
        <video id="scanner-video" autoplay></video>
        <button id="start-scanner">Start Scanner</button>
        <p id="scan-result"></p>
    </div>

    <!-- Location Section -->
    <form method="post">
        <div class="info-section">
            <label>Scanned Location:</label>
            <input type="text" id="location" name="ScannedLocation" readonly />

            <div id="location-confirm">
                <p>Is this location correct?</p>
                <button type="button" id="yes-btn" class="btn-confirm">Yes</button>
                <button type="button" id="no-btn" class="btn-confirm">No</button>
            </div>

            <div id="manual-location-container" style="display:none;">
                <label>Enter Correct Location:</label>
                <input type="text" id="manual-location" name="ManualLocation" placeholder="Type location here..." />
            </div>
        </div>

        <button type="submit" id="update-btn" class="btn-update" disabled>Update</button>
    </form>
</div>

<style>
/* Body & Page */
.scanner-page {
    max-width: 500px;
    margin: 40px auto;
    padding: 30px;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9f9f9;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

/* Title */
h2 {
    margin-bottom: 25px;
    color: #333;
}

/* Scanner Video */
.scanner-container {
    margin-bottom: 25px;
}

#scanner-video {
    width: 100%;
    max-height: 300px;
    border-radius: 12px;
    border: 2px solid #667eea;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 10px;
}

#start-scanner {
    padding: 10px 20px;
    background: #667eea;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}

#start-scanner:hover {
    background: #5a67d8;
}

/* Info Section */
.info-section {
    text-align: left;
    margin-bottom: 20px;
}

.info-section label {
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}

.info-section input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
}

/* Location Confirm Buttons */
#location-confirm p {
    margin-bottom: 8px;
    font-weight: 500;
}

.btn-confirm {
    padding: 8px 16px;
    margin-right: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    background: #667eea;
    transition: 0.3s;
}

.btn-confirm:hover {
    background: #5a67d8;
}

/* Manual input */
#manual-location-container input {
    margin-top: 5px;
}

/* Update Button */
.btn-update {
    width: 100%;
    padding: 12px;
    background: #28a745;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: 0.3s;
}

.btn-update:hover:enabled {
    background: #218838;
}

.btn-update:disabled {
    background: #ccc;
    cursor: not-allowed;
}
</style>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        const startBtn = document.getElementById('start-scanner');
        const video = document.getElementById('scanner-video');
        const scanResult = document.getElementById('scan-result');
        const locationInput = document.getElementById('location');
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');
        const manualContainer = document.getElementById('manual-location-container');
        const manualInput = document.getElementById('manual-location');
        const updateBtn = document.getElementById('update-btn');

        startBtn.addEventListener('click', () => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(stream => {
                        video.srcObject = stream;
                        video.setAttribute("playsinline", true);
                        video.play();
                        initQuagga();
                    })
                    .catch(err => alert("Camera access denied: " + err));
            } else {
                alert("getUserMedia not supported.");
            }
        });

        function initQuagga() {
            Quagga.init({
                inputStream: {
                    type : "LiveStream",
                    target: video,
                    constraints: { facingMode: "environment" }
                },
                decoder: {
                    readers: ["code_128_reader","ean_reader","ean_8_reader","upc_reader","upc_e_reader"]
                }
            }, function(err) {
                if (err) { console.log(err); return; }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                scanResult.innerText = "Scanned Code: " + code;
                locationInput.value = "Warehouse A"; // Example
                manualContainer.style.display = "none";
                updateBtn.disabled = true;
                Quagga.stop();
            });
        }

        yesBtn.addEventListener('click', () => {
            updateBtn.disabled = false;
            manualContainer.style.display = "none";
        });

        noBtn.addEventListener('click', () => {
            manualContainer.style.display = "block";
            updateBtn.disabled = true;
        });

        manualInput.addEventListener('input', () => {
            updateBtn.disabled = manualInput.value.trim() === '';
        });
    </script>
}
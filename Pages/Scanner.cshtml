@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

<link rel="stylesheet" href="~/css/scanner.css" />

<div class="scanner-page">
    <div class="scanner-header">
        <h2>Scanner</h2>
    </div>

    <div class="scanner-grid">
        <!-- Left: Camera / scan -->
        <div class="scan-card">
            

            <div class="video-wrap" id="video-wrap">
                <video id="scanner-video" autoplay playsinline></video>
                <div class="video-hint">Point camera at barcode</div>
            </div>
<div class="scan-top">
                <button id="start-scanner" class="btn btn-primary" type="button">
                    Start Scanner
                </button>
            </div>
            <p id="scan-result" class="scan-result"></p>
        </div>

        <!-- Right: Details -->
        <div class="details-card">
            <div class="section">
                <label>Scanned Location</label>
                <input type="text" id="location" readonly />
            </div>

            <div id="location-confirm" class="confirm-box">
                <p>Is this location correct?</p>
                <div class="confirm-actions">
                    <button type="button" id="yes-btn" class="btn btn-outline">Yes</button>
                    <button type="button" id="no-btn" class="btn btn-outline">No</button>
                </div>
            </div>

            <div id="manual-location-container" class="section" style="display:none;">
                <label>Select Correct Location</label>
                <select id="manual-location"></select>
            </div>

            <div class="section">
                <label>Remarks</label>
                <input type="text" id="remark1" placeholder="Remark 1" />
                <input type="text" id="remark2" placeholder="Remark 2" />
                <input type="text" id="remark3" placeholder="Remark 3" />
            </div>

            <button id="update-btn" class="btn btn-success" disabled>Update</button>

<a href="/" class="btn btn-outline" style="margin-top:10px; display:inline-block;">
    ← Back to Dashboard
</a>


                </div>
    </div>
</div>

@section Scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        const startBtn = document.getElementById('start-scanner');
        const video = document.getElementById('scanner-video');
        const videoWrap = document.getElementById('video-wrap');
        const scanResult = document.getElementById('scan-result');
        const locationInput = document.getElementById('location');
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');
        const manualContainer = document.getElementById('manual-location-container');
        const manualInput = document.getElementById('manual-location');
        const updateBtn = document.getElementById('update-btn');

        const remark1Input = document.getElementById('remark1');
        const remark2Input = document.getElementById('remark2');
        const remark3Input = document.getElementById('remark3');

        let scannerActive = false;
        let stream = null;

        // ✅ store scanned code for update
        let lastScannedCode = "";
        let lastDetectedAt = 0;

        function stopScanner() {
            try { Quagga.stop(); } catch (e) { }
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            scannerActive = false;
            startBtn.innerText = "Start Scanner";
            video.style.display = "none";
        }

        startBtn.addEventListener('click', async () => {
            if (!scannerActive) {
                video.style.display = "block";

                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                await video.play();

                Quagga.init({
                    inputStream: { type: "LiveStream", target: videoWrap },
                    decoder: { readers: ["code_128_reader", "ean_reader"] }
                }, (err) => {
                    if (err) {
                        console.error(err);
                        alert("Failed to start scanner.");
                        stopScanner();
                        return;
                    }
                    Quagga.start();
                    scannerActive = true;
                    startBtn.innerText = "Stop Scanner";
                });

            } else {
                stopScanner();
            }
        });

        Quagga.onDetected(result => {
            const now = Date.now();
            if (now - lastDetectedAt < 1200) return; // throttle
            lastDetectedAt = now;

            const scannedCode = result?.codeResult?.code || "";
            if (!scannedCode) return;

            lastScannedCode = scannedCode;

            scanResult.innerText = "Scanned: " + scannedCode;
            locationInput.value = "";
            updateBtn.disabled = true;

            stopScanner();

            fetch('/api/scanner/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: scannedCode })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Error: " + (data.message || "Unknown error"));
                    return;
                }

                if (data.exists) {
    locationInput.value = (data.location || "").trim();

    // ✅ Auto-confirm YES by default
    manualContainer.style.display = "none";
    manualInput.value = "";

    // ✅ Enable Update immediately (not faded)
    updateBtn.disabled = !lastScannedCode;

    // (optional) scroll to remarks/update area
    // updateBtn.scrollIntoView({ behavior: "smooth", block: "center" });
} else {

                    locationInput.value = "";
                    manualContainer.style.display = "none";
                    updateBtn.disabled = true;
                    alert(data.message || "Code not found.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error validating code! Check console.");
            });
        });

        yesBtn.onclick = () => {
            manualContainer.style.display = "none";
            manualInput.value = "";
            updateBtn.disabled = !lastScannedCode;
        };

        noBtn.onclick = () => {
            manualContainer.style.display = "block";
            updateBtn.disabled = true;

            fetch('/api/scanner/locations')
                .then(res => res.json())
                .then(data => {
                    if (data.success && Array.isArray(data.locations)) {
                        manualInput.innerHTML = '';

                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.text = '-- Select Location --';
                        manualInput.appendChild(placeholder);

                        data.locations.forEach(loc => {
                            const opt = document.createElement('option');
                            opt.value = loc;
                            opt.text = loc;
                            manualInput.appendChild(opt);
                        });

                        manualInput.onchange = () => {
                            updateBtn.disabled = (manualInput.value === '') || !lastScannedCode;
                        };
                    } else {
                        alert("Failed to load locations.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to load locations!");
                });
        };

        // ✅ Update -> insert new record
        updateBtn.addEventListener('click', () => {
            if (!lastScannedCode) {
                alert("No scanned code.");
                return;
            }

            const chosenLocation =
                (manualContainer.style.display === "block" && manualInput.value)
                    ? manualInput.value
                    : (locationInput.value || "");

            fetch('/api/scanner/insert-detail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code: lastScannedCode,
                    locationDesc: chosenLocation,
                    remark1: remark1Input.value || "",
                    remark2: remark2Input.value || "",
                    remark3: remark3Input.value || ""
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Insert failed: " + (data.message || "Unknown error"));
                    return;
                }
                alert("Inserted successfully!");
                updateBtn.disabled = true;
            })
            .catch(err => {
                console.error(err);
                alert("Insert failed! Check console.");
            });
        });
    </script>
}

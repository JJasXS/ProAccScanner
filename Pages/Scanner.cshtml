@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

 <link rel="stylesheet" href="~/css/scanner.css" />-->

<div class="scanner-page">
    <div class="scanner-header">
        <h2>Scanner</h2>
        <p>Scan barcode, confirm location, add remarks, then update.</p>
    </div>

    <div class="scanner-grid">
        <!-- Left: Camera / scan -->
        <div class="scan-card">
            <div class="scan-top">
                

                <button id="start-scanner" class="btn btn-primary" type="button">
                    Start Scanner
                </button>
            </div>

            <div class="video-wrap">
                <video id="scanner-video" autoplay playsinline></video>
                <div class="video-hint">Point camera at barcode</div>
            </div>

            <p id="scan-result" class="scan-result"></p>
        </div>

        <!-- Right: Details -->
        <div class="details-card">
            <div class="section">
                <label>Scanned Location</label>
                <input type="text" id="location" readonly />
            </div>

            <div id="location-confirm" class="confirm-box">
                <p>Is this location correct?</p>
                <div class="confirm-actions">
                    <button type="button" id="yes-btn" class="btn btn-outline">Yes</button>
                    <button type="button" id="no-btn" class="btn btn-outline">No</button>
                </div>
            </div>

            <div id="manual-location-container" class="section" style="display:none;">
                <label>Select Correct Location</label>
                <select id="manual-location"></select>
            </div>

            <div class="section">
                <label>Remarks</label>
                <input type="text" id="remark1" placeholder="Remark 1" />
                <input type="text" id="remark2" placeholder="Remark 2" />
                <input type="text" id="remark3" placeholder="Remark 3" />
            </div>

            <button id="update-btn" class="btn btn-success" disabled>Update</button>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const startBtn = document.getElementById('start-scanner');
const video = document.getElementById('scanner-video');
const scanResult = document.getElementById('scan-result');
const locationInput = document.getElementById('location');
const yesBtn = document.getElementById('yes-btn');
const noBtn = document.getElementById('no-btn');
const manualContainer = document.getElementById('manual-location-container');
const manualInput = document.getElementById('manual-location');
const updateBtn = document.getElementById('update-btn');

let scannerActive = false;
let stream = null;

// Start / Stop scanner
startBtn.addEventListener('click', async () => {
    if (!scannerActive) {
        video.style.display = "block";
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        await video.play();

        Quagga.init({
            inputStream: { type: "LiveStream", target: video },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, () => Quagga.start());

        scannerActive = true;
        startBtn.innerText = "Stop Scanner";
    } else {
        stream.getTracks().forEach(t => t.stop());
        Quagga.stop();
        scannerActive = false;
        startBtn.innerText = "Start Scanner";
        video.style.display = "none";
    }
});

// Barcode detected
Quagga.onDetected(result => {
    const scannedCode = result.codeResult.code;
    scanResult.innerText = "Scanned: " + scannedCode;
    locationInput.value = "";
    updateBtn.disabled = true;
    startBtn.click(); // stop scanner

    fetch('/api/scanner/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: scannedCode })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Error: " + data.message);
            return;
        }

        if (data.exists) {
            if (data.location && data.location.trim() !== "") {
                locationInput.value = data.location;
            } else {
                locationInput.value = "";
            }
            manualContainer.style.display = "none";
            updateBtn.disabled = true;
        } else {
            locationInput.value = "";
            manualContainer.style.display = "none";
            updateBtn.disabled = true;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error validating code! Check console for details.");
    });
});

// Manual confirmation logic
yesBtn.onclick = () => {
    manualContainer.style.display = "none";
    updateBtn.disabled = false;
    manualInput.value = "";
};

noBtn.onclick = () => {
    manualContainer.style.display = "block";
    updateBtn.disabled = true;

    fetch('/api/scanner/locations')
        .then(res => res.json())
        .then(data => {
            if (data.success && Array.isArray(data.locations)) {
                manualInput.innerHTML = '';

                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.text = '-- Select Location --';
                manualInput.appendChild(placeholder);

                data.locations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.text = loc;
                    manualInput.appendChild(opt);
                });

                manualInput.onchange = () => {
                    updateBtn.disabled = manualInput.value === '';
                };
            }
        })
        .catch(err => {
            console.error(err);
            alert("Failed to load locations!");
        });
};
</script>
}

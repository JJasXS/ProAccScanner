@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

<link rel="stylesheet" href="~/css/scanner.css" />

<div class="scanner-page">
    <div class="scanner-header">
        <h2>Scanner</h2>
    </div>

    <div class="scanner-grid">
        <!-- Left: Camera / scan -->
        <div class="scan-card">
            <div class="video-wrap" id="video-wrap">
                <video id="scanner-video" autoplay playsinline></video>
                <div class="video-hint">Point camera at barcode</div>
            </div>

            <div class="scan-top">
                <button id="start-scanner" class="btn btn-primary" type="button">
                    Start Scanner
                </button>
            </div>

            <p id="scan-result" class="scan-result"></p>
        </div>

        <!-- Right: Details -->
        <div class="details-card">
            <div class="section">
                <label>Scanned Location</label>
                <input type="text" id="location" readonly />
            </div>

            <div id="location-confirm" class="confirm-box">
                <p>Is this location correct?</p>
                <div class="confirm-actions">
                    <button type="button" id="yes-btn" class="btn btn-outline">Yes</button>
                    <button type="button" id="no-btn" class="btn btn-outline">No</button>
                </div>
            </div>

            <div id="manual-location-container" class="section" style="display:none;">
                <label>Select Correct Location</label>
                <select id="manual-location"></select>
            </div>

            <div class="section">
                <label>Remarks</label>
                <input type="text" id="remark1" placeholder="Remark 1" />
                <input type="text" id="remark2" placeholder="Remark 2" />
                <input type="text" id="remark3" placeholder="Remark 3" />
            </div>

            <button id="update-btn" class="btn btn-success" disabled>Update</button>

            <a href="Dashboard" class="btn btn-outline" style="margin-top:10px; display:inline-block;">
                ← Back to Dashboard
            </a>
        </div>
    </div>
</div>

@section Scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        // ----------------------------
        // DOM
        // ----------------------------
        const startBtn = document.getElementById('start-scanner');
        const video = document.getElementById('scanner-video');
        const videoWrap = document.getElementById('video-wrap');
        const scanResult = document.getElementById('scan-result');
        const locationInput = document.getElementById('location');
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');
        const manualContainer = document.getElementById('manual-location-container');
        const manualInput = document.getElementById('manual-location');
        const updateBtn = document.getElementById('update-btn');

        const remark1Input = document.getElementById('remark1');
        const remark2Input = document.getElementById('remark2');
        const remark3Input = document.getElementById('remark3');

        // ----------------------------
        // State
        // ----------------------------
        let scannerActive = false;
        let stream = null;

        let lastScannedCode = "";
        let lastDetectedAt = 0;

        // ----------------------------
        // Yes/No selected indicator
        // ----------------------------
        function setConfirmSelected(which) {
            yesBtn.classList.remove("btn-selected-yes");
            noBtn.classList.remove("btn-selected-no");

            if (which === "yes") yesBtn.classList.add("btn-selected-yes");
            if (which === "no") noBtn.classList.add("btn-selected-no");
        }

        function clearConfirmSelected() {
            yesBtn.classList.remove("btn-selected-yes");
            noBtn.classList.remove("btn-selected-no");
        }

        // ----------------------------
        // ✅ Popup modal (created dynamically)
        // ----------------------------
        let modalEl = null;

        function ensureModal() {
            if (modalEl) return;

            modalEl = document.createElement("div");
            modalEl.id = "updated-modal";
            modalEl.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,.45);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 999999;
            `;

            const card = document.createElement("div");
            card.style.cssText = `
                width: min(420px, calc(100% - 40px));
                background: #fff;
                border-radius: 12px;
                padding: 18px 16px;
                box-shadow: 0 10px 30px rgba(0,0,0,.25);
                font-family: inherit;
            `;

            // ✅ Next scan (top) + Back (bottom)
            card.innerHTML = `
                <h3 style="margin:0 0 8px 0;">Updated ✅</h3>
                <p style="margin:0 0 14px 0; color:#444;">Record inserted successfully.</p>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button type="button" id="next-scan-btn" class="btn btn-primary" style="width:100%;">
                        Next scan
                    </button>

                    <a href="Dashboard" id="back-dashboard-btn" class="btn btn-outline" style="width:100%; text-align:center;">
                        Back
                    </a>
                </div>
            `;

            modalEl.appendChild(card);
            document.body.appendChild(modalEl);

            // click outside card = close
            modalEl.addEventListener("click", (e) => {
                if (e.target === modalEl) hideUpdatedModal();
            });

            // ESC = close
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") hideUpdatedModal();
            });

            // Next scan handler
            const nextBtn = card.querySelector("#next-scan-btn");
            nextBtn.addEventListener("click", () => {
                resetForNextScan();
                hideUpdatedModal();
            });
        }

        function showUpdatedModal() {
            ensureModal();
            modalEl.style.display = "flex";
        }

        function hideUpdatedModal() {
            if (!modalEl) return;
            modalEl.style.display = "none";
        }

        // ----------------------------
        // Reset / next scan
        // ----------------------------
        function resetForNextScan() {
            scanResult.innerText = "";
            locationInput.value = "";

            remark1Input.value = "";
            remark2Input.value = "";
            remark3Input.value = "";

            clearConfirmSelected();

            lastScannedCode = "";
            manualContainer.style.display = "none";
            manualInput.innerHTML = "";
            manualInput.value = "";

            updateBtn.disabled = true;

            // ✅ auto start scanner again
            if (!scannerActive) startBtn.click();
        }

        // ----------------------------
        // Scanner control
        // ----------------------------
        function stopScanner() {
            try { Quagga.stop(); } catch (e) { }
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            scannerActive = false;
            startBtn.innerText = "Start Scanner";
            video.style.display = "none";
        }

        startBtn.addEventListener('click', async () => {
            if (!scannerActive) {
                try {
                    video.style.display = "block";

                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });

                    video.srcObject = stream;
                    await video.play();

                    Quagga.init({
                        inputStream: { type: "LiveStream", target: videoWrap },
                        decoder: { readers: ["code_128_reader", "ean_reader"] }
                    }, (err) => {
                        if (err) {
                            console.error(err);
                            alert("Failed to start scanner.");
                            stopScanner();
                            return;
                        }
                        Quagga.start();
                        scannerActive = true;
                        startBtn.innerText = "Stop Scanner";
                    });

                } catch (e) {
                    console.error(e);
                    alert("Camera permission blocked / camera not available.");
                    stopScanner();
                }
            } else {
                stopScanner();
            }
        });

        Quagga.onDetected(result => {
            const now = Date.now();
            if (now - lastDetectedAt < 1200) return; // throttle
            lastDetectedAt = now;

            const scannedCode = result?.codeResult?.code || "";
            if (!scannedCode) return;

            lastScannedCode = scannedCode;

            scanResult.innerText = "Scanned: " + scannedCode;
            locationInput.value = "";
            updateBtn.disabled = true;

            stopScanner();

            fetch('/api/scanner/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: scannedCode })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Error: " + (data.message || "Unknown error"));
                    return;
                }

                if (data.exists) {
                    locationInput.value = (data.location || "").trim();

                    // ✅ auto set YES selected (green)
                    setConfirmSelected("yes");

                    // ✅ hide manual selection
                    manualContainer.style.display = "none";
                    manualInput.value = "";

                    // ✅ enable update immediately
                    updateBtn.disabled = !lastScannedCode;
                } else {
                    locationInput.value = "";
                    manualContainer.style.display = "none";
                    updateBtn.disabled = true;
                    clearConfirmSelected();
                    alert(data.message || "Code not found.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error validating code! Check console.");
            });
        });

        // ----------------------------
        // Yes / No behavior
        // ----------------------------
        yesBtn.onclick = () => {
            setConfirmSelected("yes");

            manualContainer.style.display = "none";
            manualInput.value = "";
            updateBtn.disabled = !lastScannedCode;
        };

        noBtn.onclick = () => {
            setConfirmSelected("no");

            manualContainer.style.display = "block";
            updateBtn.disabled = true;

            fetch('/api/scanner/locations')
                .then(res => res.json())
                .then(data => {
                    if (data.success && Array.isArray(data.locations)) {
                        manualInput.innerHTML = '';

                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.text = '-- Select Location --';
                        manualInput.appendChild(placeholder);

                        data.locations.forEach(loc => {
                            const opt = document.createElement('option');
                            opt.value = loc;
                            opt.text = loc;
                            manualInput.appendChild(opt);
                        });

                        manualInput.onchange = () => {
                            updateBtn.disabled = (manualInput.value === '') || !lastScannedCode;
                        };
                    } else {
                        alert("Failed to load locations.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to load locations!");
                });
        };

        // ----------------------------
        // Update -> insert new record
        // ----------------------------
        updateBtn.addEventListener('click', () => {
            if (!lastScannedCode) {
                alert("No scanned code.");
                return;
            }

            const chosenLocation =
                (manualContainer.style.display === "block" && manualInput.value)
                    ? manualInput.value
                    : (locationInput.value || "");

            fetch('/api/scanner/insert-detail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code: lastScannedCode,
                    locationDesc: chosenLocation,
                    remark1: remark1Input.value || "",
                    remark2: remark2Input.value || "",
                    remark3: remark3Input.value || ""
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Insert failed: " + (data.message || "Unknown error"));
                    return;
                }

                updateBtn.disabled = true;
                showUpdatedModal();
            })
            .catch(err => {
                console.error(err);
                alert("Insert failed! Check console.");
            });
        });
    </script>
}

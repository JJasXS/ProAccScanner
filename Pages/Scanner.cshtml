@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

<link rel="stylesheet" href="~/css/scanner.css" />

<div class="scanner-page">

    <!-- ✅ Top bar with hamburger -->
    <div class="top-row">
        <button id="menuBtn" class="hamburger-btn" type="button" aria-label="Menu">
            ☰
        </button>
       <center> <div class="top-title">Scanner</div> </center>
    </div>

    <!-- ✅ Slide menu -->
    <div id="menuOverlay" class="menu-overlay" style="display:none;"></div>

    <div id="sideMenu" class="side-menu">
        <div class="side-menu-header">
            <div class="side-menu-title">Menu</div>
            <button id="closeMenuBtn" class="side-menu-close" type="button" aria-label="Close">
                ✕
            </button>
        </div>

        <a href="Dashboard" class="menu-item">← Back to Dashboard</a>
        <a href="Login" class="menu-item">← Back to Login</a>

        <!-- optional logout -->
        <a href="Index" class="menu-item menu-item-danger">Log out</a>
    </div>

    <div class="scanner-grid">
        <!-- Left: Camera / scan -->
        <div class="scan-card">
            <div class="video-wrap" id="video-wrap">
                <video id="scanner-video" autoplay playsinline></video>
                <div class="video-hint">Point camera at barcode</div>
            </div>

            <div class="scan-top">
                <button id="start-scanner" class="btn btn-primary" type="button">
                    Start Scanner
                </button>
            </div>

            <p id="scan-result" class="scan-result"></p>
        </div>

        <!-- Right: Details -->
        <div class="details-card">
            <div class="section">
                <label>Scanned Location</label>
                <input type="text" id="location" readonly />
            </div>

            <div id="location-confirm" class="confirm-box">
                <p>Is this location correct?</p>
                <div class="confirm-actions">
                    <button type="button" id="yes-btn" class="btn btn-outline">Yes</button>
                    <button type="button" id="no-btn" class="btn btn-outline">No</button>
                </div>
            </div>

            <div id="manual-location-container" class="section" style="display:none;">
                <label>Select Correct Location</label>
                <select id="manual-location"></select>
            </div>

            <div class="section">
                <label>Remarks</label>
                <input type="text" id="remark1" placeholder="Remark 1" />
                <input type="text" id="remark2" placeholder="Remark 2" />
                <input type="text" id="remark3" placeholder="Remark 3" />
            </div>

            <button id="update-btn" class="btn btn-success" disabled>Update</button>

           
        </div>
    </div>
</div>

@section Scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        // ----------------------------
        // ✅ Hamburger menu logic
        // ----------------------------
        const menuBtn = document.getElementById('menuBtn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const sideMenu = document.getElementById('sideMenu');
        const menuOverlay = document.getElementById('menuOverlay');

        function openMenu() {
            sideMenu.classList.add('open');
            menuOverlay.style.display = 'block';
            setTimeout(() => menuOverlay.classList.add('show'), 0);
        }

        function closeMenu() {
            sideMenu.classList.remove('open');
            menuOverlay.classList.remove('show');
            setTimeout(() => menuOverlay.style.display = 'none', 200);
        }

        menuBtn.addEventListener('click', openMenu);
        closeMenuBtn.addEventListener('click', closeMenu);
        menuOverlay.addEventListener('click', closeMenu);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeMenu();
        });

        // ----------------------------
        // DOM
        // ----------------------------
        const startBtn = document.getElementById('start-scanner');
        const video = document.getElementById('scanner-video');
        const videoWrap = document.getElementById('video-wrap');
        const scanResult = document.getElementById('scan-result');

        const locationInput = document.getElementById('location');
        const yesBtn = document.getElementById('yes-btn');
        const noBtn = document.getElementById('no-btn');

        const manualContainer = document.getElementById('manual-location-container');
        const manualInput = document.getElementById('manual-location');

        const remark1Input = document.getElementById('remark1');
        const remark2Input = document.getElementById('remark2');
        const remark3Input = document.getElementById('remark3');

        const updateBtn = document.getElementById('update-btn');

        // ----------------------------
        // State
        // ----------------------------
        let scannerActive = false;
        let stream = null;
        let lastScannedCode = "";
        let lastDetectedAt = 0;

        // ----------------------------
        // Yes/No indicator
        // ----------------------------
        function setConfirmSelected(which) {
            yesBtn.classList.remove("btn-selected-yes");
            noBtn.classList.remove("btn-selected-no");

            if (which === "yes") yesBtn.classList.add("btn-selected-yes");
            if (which === "no")  noBtn.classList.add("btn-selected-no");
        }

        function clearConfirmSelected() {
            yesBtn.classList.remove("btn-selected-yes");
            noBtn.classList.remove("btn-selected-no");
        }

        // ----------------------------
        // Updated Modal
        // ----------------------------
        let modalEl = null;

        function ensureModal() {
            if (modalEl) return;

            modalEl = document.createElement("div");
            modalEl.id = "updated-modal";
            modalEl.className = "modal-overlay";

            const card = document.createElement("div");
            card.className = "modal-card";

            card.innerHTML = `
                <h3 class="modal-title">Updated ✅</h3>
                <p class="modal-desc">Record inserted successfully.</p>

                <div class="modal-actions">
                    <button type="button" id="next-scan-btn" class="btn btn-primary">
                        Next scan
                    </button>

                    <a href="Dashboard" class="btn btn-outline">
                        Back
                    </a>
                </div>
            `;

            modalEl.appendChild(card);
            document.body.appendChild(modalEl);

            modalEl.addEventListener("click", (e) => {
                if (e.target === modalEl) hideUpdatedModal();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") hideUpdatedModal();
            });

            card.querySelector("#next-scan-btn").addEventListener("click", () => {
                resetForNextScan();
                hideUpdatedModal();
            });
        }

        function showUpdatedModal() {
            ensureModal();
            modalEl.classList.add("show");
        }

        function hideUpdatedModal() {
            if (!modalEl) return;
            modalEl.classList.remove("show");
        }

        // ----------------------------
        // Reset for next scan
        // ----------------------------
        function resetForNextScan() {
            scanResult.innerText = "";
            locationInput.value = "";

            remark1Input.value = "";
            remark2Input.value = "";
            remark3Input.value = "";

            manualContainer.style.display = "none";
            manualInput.innerHTML = "";
            manualInput.value = "";

            clearConfirmSelected();

            lastScannedCode = "";
            updateBtn.disabled = true;

            if (!scannerActive) startBtn.click();
        }

        // ----------------------------
        // Scanner control
        // ----------------------------
        function stopScanner() {
            try { Quagga.stop(); } catch (e) {}
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            scannerActive = false;
            startBtn.innerText = "Start Scanner";
            video.style.display = "none";
        }

        async function startScanner() {
            video.style.display = "block";

            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });

            video.srcObject = stream;
            await video.play();

            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    target: videoWrap,
                    constraints: {
                        facingMode: "environment"
                    }
                },
                locator: { patchSize: "medium", halfSample: true },
                decoder: { readers: ["code_128_reader", "ean_reader"] }
            }, (err) => {
                if (err) {
                    console.error(err);
                    alert("Failed to start scanner.");
                    stopScanner();
                    return;
                }
                Quagga.start();
                scannerActive = true;
                startBtn.innerText = "Stop Scanner";
            });
        }

        startBtn.addEventListener("click", async () => {
            if (scannerActive) {
                stopScanner();
                return;
            }

            try {
                await startScanner();
            } catch (e) {
                console.error(e);
                alert("Camera permission blocked / camera not available.");
                stopScanner();
            }
        });

        // ----------------------------
        // Quagga detected
        // ----------------------------
        Quagga.onDetected((result) => {
            const now = Date.now();
            if (now - lastDetectedAt < 1200) return;
            lastDetectedAt = now;

            const scannedCode = result?.codeResult?.code || "";
            if (!scannedCode) return;

            lastScannedCode = scannedCode;

            scanResult.innerText = "Scanned: " + scannedCode;
            locationInput.value = "";
            updateBtn.disabled = true;

            stopScanner();

            fetch('/api/scanner/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: scannedCode })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Error: " + (data.message || "Unknown error"));
                    return;
                }

                if (data.exists) {
                    locationInput.value = (data.location || "").trim();

                    setConfirmSelected("yes");

                    manualContainer.style.display = "none";
                    manualInput.value = "";

                    updateBtn.disabled = !lastScannedCode;
                } else {
                    clearConfirmSelected();
                    manualContainer.style.display = "none";
                    updateBtn.disabled = true;
                    alert(data.message || "Code not found.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error validating code! Check console.");
            });
        });

        // ----------------------------
        // Yes / No logic
        // ----------------------------
        yesBtn.addEventListener("click", () => {
            setConfirmSelected("yes");
            manualContainer.style.display = "none";
            manualInput.value = "";
            updateBtn.disabled = !lastScannedCode;
        });

        noBtn.addEventListener("click", () => {
            setConfirmSelected("no");
            manualContainer.style.display = "block";
            updateBtn.disabled = true;

            fetch('/api/scanner/locations')
                .then(res => res.json())
                .then(data => {
                    if (!data.success || !Array.isArray(data.locations)) {
                        alert("Failed to load locations.");
                        return;
                    }

                    manualInput.innerHTML = "";

                    const placeholder = document.createElement("option");
                    placeholder.value = "";
                    placeholder.text = "-- Select Location --";
                    manualInput.appendChild(placeholder);

                    data.locations.forEach(loc => {
                        const opt = document.createElement("option");
                        opt.value = loc;
                        opt.text = loc;
                        manualInput.appendChild(opt);
                    });

                    manualInput.onchange = () => {
                        updateBtn.disabled = (manualInput.value === "") || !lastScannedCode;
                    };
                })
                .catch(err => {
                    console.error(err);
                    alert("Failed to load locations!");
                });
        });

        // ----------------------------
        // Update -> insert record
        // ----------------------------
        updateBtn.addEventListener("click", () => {
            if (!lastScannedCode) {
                alert("No scanned code.");
                return;
            }

            const chosenLocation =
                (manualContainer.style.display === "block" && manualInput.value)
                    ? manualInput.value
                    : (locationInput.value || "");

            fetch('/api/scanner/insert-detail', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    code: lastScannedCode,
                    locationDesc: chosenLocation,
                    remark1: remark1Input.value || "",
                    remark2: remark2Input.value || "",
                    remark3: remark3Input.value || ""
                })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert("Insert failed: " + (data.message || "Unknown error"));
                    return;
                }

                updateBtn.disabled = true;
                showUpdatedModal();
            })
            .catch(err => {
                console.error(err);
                alert("Insert failed! Check console.");
            });
        });
    </script>
}

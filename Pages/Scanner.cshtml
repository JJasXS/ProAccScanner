@page
@model FirebirdWeb.Pages.ScannerModel
@{
    ViewData["Title"] = "Scanner";
}

<link rel="stylesheet" href="~/css/scanner.css" />

<h2>Scanner</h2>

<div class="scanner-container">
    <video id="scanner-video" autoplay playsinline style="width:100%; max-height:300px;"></video>
    <button id="start-scanner">Start Scanner</button>
    <p id="scan-result"></p>
</div>

<div class="info-section">
    <label>Scanned Location</label>
    <input type="text" id="location" readonly />

    <div id="location-confirm">
        <p>Is this location correct?</p>
        <button type="button" id="yes-btn">Yes</button>
        <button type="button" id="no-btn">No</button>
    </div>

    <div id="manual-location-container" style="display:none;">
        <label>Select Correct Location</label>
        <select id="manual-location"></select>
    </div>

    <button id="update-btn" disabled>Update</button>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
const startBtn = document.getElementById('start-scanner');
const video = document.getElementById('scanner-video');
const scanResult = document.getElementById('scan-result');
const locationInput = document.getElementById('location');
const yesBtn = document.getElementById('yes-btn');
const noBtn = document.getElementById('no-btn');
const manualContainer = document.getElementById('manual-location-container');
const manualInput = document.getElementById('manual-location');
const updateBtn = document.getElementById('update-btn');

let scannerActive = false;
let stream = null;

// Start / Stop scanner
startBtn.addEventListener('click', async () => {
    if (!scannerActive) {
        video.style.display = "block";
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        await video.play();

        Quagga.init({
            inputStream: { type: "LiveStream", target: video },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, () => Quagga.start());

        scannerActive = true;
        startBtn.innerText = "Stop Scanner";
    } else {
        stream.getTracks().forEach(t => t.stop());
        Quagga.stop();
        scannerActive = false;
        startBtn.innerText = "Start Scanner";
        video.style.display = "none";
    }
});

// Barcode detected
Quagga.onDetected(result => {
    const scannedCode = result.codeResult.code;
    scanResult.innerText = "Scanned: " + scannedCode;
    locationInput.value = "";
    updateBtn.disabled = true;
    startBtn.click(); // stop scanner

    fetch('/api/scanner/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: scannedCode })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("Error: " + data.message);
            return;
        }

        if (data.exists) {
            // ✅ Show location if exists
            if (data.location && data.location.trim() !== "") {
                locationInput.value = data.location;
            } else {
                locationInput.value = "";
            }
            manualContainer.style.display = "none";
            updateBtn.disabled = true;
        } else {
            // ❌ Code not found → blank input
            locationInput.value = "";
            manualContainer.style.display = "none";
            updateBtn.disabled = true;
        }
    })
    .catch(err => {
        console.error(err);
        alert("Error validating code! Check console for details.");
    });
});

// Manual confirmation logic
yesBtn.onclick = () => {
    manualContainer.style.display = "none";
    updateBtn.disabled = false;
    manualInput.value = "";
};

noBtn.onclick = () => {
    manualContainer.style.display = "block";
    updateBtn.disabled = true;

    // Fetch all existing locations from API
    fetch('/api/scanner/locations')
        .then(res => res.json())
        .then(data => {
            if (data.success && Array.isArray(data.locations)) {
                // Clear previous options
                manualInput.innerHTML = '';
                // Add placeholder
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.text = '-- Select Location --';
                manualInput.appendChild(placeholder);

                // Add all locations
                data.locations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.text = loc;
                    manualInput.appendChild(opt);
                });

                // Enable update button only when a selection is made
                manualInput.onchange = () => {
                    updateBtn.disabled = manualInput.value === '';
                };
            }
        })
        .catch(err => {
            console.error(err);
            alert("Failed to load locations!");
        });
};
</script>
}
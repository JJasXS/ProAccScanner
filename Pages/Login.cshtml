@page
@model FirebirdWeb.Pages.LoginModel
@{
    ViewData["Title"] = "Login";
}

<link rel="stylesheet" href="~/css/login.css" />

<div class="login-container">
    <!-- ✅ Back like Register -->
    <div class="top-row">
        <a class="back-link" asp-page="/Index">← Back</a>
    </div>

    <h2>Login with OTP</h2>

    <!-- Email input group -->
    <div id="emailGroup">
        <input type="email" id="email" placeholder="Enter your email" />
        <button id="sendBtn" type="button">Send OTP</button>

        <!-- ✅ Not registered link -->
        <div class="helper-links">
            <span>Not registered?</span>
            <a asp-page="/Register">Create account</a>
        </div>
    </div>

    <!-- OTP input group -->
    <div id="otpGroup" style="display:none;">
        <!-- ✅ store email here so VerifyOTP always has it -->
        <input type="hidden" id="emailHidden" />

        <div class="otp-boxes">
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
        </div>

        <button id="verifyBtn" type="button">Verify OTP</button>
    </div>

    <div id="message"></div>
</div>

<script>
const msg = (t) => document.getElementById('message').innerText = t;

// Send OTP
document.getElementById('sendBtn').addEventListener('click', async () => {
    const email = (document.getElementById('email').value || '').trim();

    if (!email) { msg("Please enter your email."); return; }

    const formData = new FormData();
    formData.append('Email', email);

    try {
        const res = await fetch('@Url.Page("/Login", null, new { handler = "SendOTP" })', {
            method: 'POST',
            body: formData
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            msg(data?.message || "Error sending OTP.");
            return;
        }

        msg(data.message || "");

        if (data.success) {
            // ✅ store email for OTP verify step
            document.getElementById('emailHidden').value = email;

            document.getElementById('emailGroup').style.display = 'none';
            document.getElementById('otpGroup').style.display = 'block';

            // focus first otp
            document.querySelector('.otp')?.focus();
        }
    } catch (err) {
        msg("Error sending OTP.");
    }
});

// OTP auto-focus and numeric-only
document.querySelectorAll('.otp').forEach((input, idx, arr) => {
    input.addEventListener('input', () => {
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value && idx < arr.length - 1) arr[idx + 1].focus();
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && idx > 0) {
            arr[idx - 1].focus();
        }
    });
});

// Verify OTP
document.getElementById('verifyBtn').addEventListener('click', async () => {
    const email = (document.getElementById('emailHidden').value || '').trim();
    const otp = Array.from(document.querySelectorAll('.otp')).map(i => i.value).join('');

    if (!email) { msg("Email missing. Please go back and enter your email."); return; }
    if (otp.length < 6) { msg("Please enter all 6 OTP digits."); return; }

    const formData = new FormData();
    formData.append('Email', email);
    formData.append('OTP', otp);

    try {
        const res = await fetch('@Url.Page("/Login", null, new { handler = "VerifyOTP" })', {
            method: 'POST',
            body: formData
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
            msg(data?.message || "Error verifying OTP.");
            return;
        }

        msg(data.message || "");

        if (data.success) {
            window.location.href = data.redirectUrl || '/Dashboard';
        }
    } catch (err) {
        msg("Error verifying OTP.");
    }
});
</script>

@page
@model FirebirdWeb.Pages.LoginModel
@{
    ViewData["Title"] = "Login";
}

<link rel="stylesheet" href="~/css/login.css" />

<div class="login-container">
    <!-- ✅ Back like Register -->
    <div class="top-row">
        <a class="back-link" asp-page="/Index">← Back</a>
    </div>

    <h2>Login with OTP</h2>

    <!-- Email input group -->
    <div id="emailGroup">
        <input type="email" id="email" placeholder="Enter your email" />
        <button id="sendBtn">Send OTP</button>

        <!-- ✅ Not registered link -->
        <div class="helper-links">
            <span>Not registered?</span>
            <a asp-page="/Register">Create account</a>
        </div>
    </div>

    <!-- OTP input group: 6 numeric boxes -->
    <div id="otpGroup">
        <div class="otp-boxes">
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
            <input type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp" />
        </div>
        <button id="verifyBtn">Verify OTP</button>
    </div>

    <div id="message"></div>
</div>

<script>
// Send OTP
document.getElementById('sendBtn').addEventListener('click', async () => {
    const emailInput = document.getElementById('email');
    const email = emailInput.value.trim();

    if (!email) {
        document.getElementById('message').innerText = "Please enter your email.";
        return;
    }

    const formData = new FormData();
    formData.append('Email', email);

    try {
        const res = await fetch('@Url.Page("/Login", null, new { handler = "SendOTP" })', {
            method: 'POST',
            body: formData
        });

        if (!res.ok) throw new Error("Network error");

        const data = await res.json();
        document.getElementById('message').innerText = data.message;

        if (data.success) {
            document.getElementById('emailGroup').style.display = 'none';
            document.getElementById('otpGroup').style.display = 'block';
            document.querySelector('.otp').focus();
        }
    } catch (err) {
        document.getElementById('message').innerText = "Error sending OTP.";
    }
});

// OTP auto-focus and numeric-only
document.querySelectorAll('.otp').forEach((input, idx, arr) => {
    input.addEventListener('input', () => {
        input.value = input.value.replace(/[^0-9]/g, '');
        if (input.value && idx < arr.length - 1) arr[idx + 1].focus();
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !input.value && idx > 0) {
            arr[idx - 1].focus();
        }
    });
});

// Verify OTP
document.getElementById('verifyBtn').addEventListener('click', async () => {
    const email = document.getElementById('emailGroup').querySelector('input')?.value.trim();
    const otp = Array.from(document.querySelectorAll('.otp')).map(i => i.value).join('');

    if (!email || otp.length < 6) {
        document.getElementById('message').innerText = "Please enter all 6 OTP digits.";
        return;
    }

    const formData = new FormData();
    formData.append('Email', email);
    formData.append('OTP', otp);

    try {
        const res = await fetch('@Url.Page("/Login", null, new { handler = "VerifyOTP" })', {
            method: 'POST',
            body: formData
        });

        if (!res.ok) throw new Error("Network error");

        const data = await res.json();
        document.getElementById('message').innerText = data.message;

        if (data.success) {
            window.location.href = data.redirectUrl || '/Dashboard';
        }
    } catch (err) {
        document.getElementById('message').innerText = "Error verifying OTP.";
    }
});
</script>

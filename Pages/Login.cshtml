@page
@model FirebirdWeb.Pages.LoginModel
@{
    ViewData["Title"] = "Login";
}

<h2>Login with OTP</h2>

<div>
    <label>Email:</label>
    <input type="email" id="email" />
    <button id="sendBtn">Send OTP</button>
</div>

<div id="otpGroup" style="display:none; margin-top:10px;">
    <label>Enter OTP:</label>
    <input type="text" id="otp" />
    <button id="verifyBtn">Verify OTP</button>
</div>

<div id="message" style="margin-top:10px; color:blue;"></div>

<script>
document.getElementById('sendBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    if (!email) {
        document.getElementById('message').innerText = "Please enter an email.";
        return;
    }

    const formData = new FormData();
    formData.append('Email', email);

    // Corrected URL for Razor Page handler
    const res = await fetch('@Url.Page("/Login", null, new { handler = "SendOTP" })', {
        method: 'POST',
        body: formData
    });

    if (!res.ok) {
        document.getElementById('message').innerText = "Error sending OTP.";
        return;
    }

    const data = await res.json();
    document.getElementById('message').innerText = data.message;

    if (data.success) {
        document.getElementById('otpGroup').style.display = 'block';
    }
});

document.getElementById('verifyBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const otp = document.getElementById('otp').value.trim();
    if (!email || !otp) {
        document.getElementById('message').innerText = "Please enter email and OTP.";
        return;
    }

    const formData = new FormData();
    formData.append('Email', email);
    formData.append('OTP', otp);

    // Corrected URL for Razor Page handler
    const res = await fetch('@Url.Page("/Login", null, new { handler = "VerifyOTP" })', {
        method: 'POST',
        body: formData
    });

    if (!res.ok) {
        document.getElementById('message').innerText = "Error verifying OTP.";
        return;
    }

    const data = await res.json();
    document.getElementById('message').innerText = data.message;

    if (data.success) {
        // Redirect to dashboard after successful OTP verification
        if (data.redirectUrl) {
            window.location.href = data.redirectUrl;
        } else {
            window.location.href = '/Dashboard';
        }
    }
});
</script>
@page
@model FirebirdWeb.Pages.RegisterModel
@{
    ViewData["Title"] = "Register";
}

<link rel="stylesheet" href="~/css/register.css" />

<div class="register-container">
    <h2>Create Account</h2>
    <p>Fill in your details to register.</p>

    <div class="top-row">
        <a class="back-link" asp-page="/Index">‚Üê Back</a>
    </div>

    <div id="errorContainer"></div>

    <form id="registerForm" novalidate>
        <input type="text" id="code" name="code" required placeholder="User Code (e.g. USER001)" autocomplete="off" />
        <input type="text" id="name" name="name" required placeholder="Full Name" autocomplete="name" />
        <input type="email" id="email" name="email" required placeholder="Email Address" autocomplete="email" />
        <input type="tel" id="mobile" name="mobile" placeholder="Mobile Number" autocomplete="tel" />

        <input type="password" id="passwd" name="passwd" required placeholder="Password (min 6 chars)" autocomplete="new-password" />
        <input type="password" id="passwdConfirm" name="passwdConfirm" required placeholder="Confirm Password" autocomplete="new-password" />

        <button type="submit" id="registerBtn">Register</button>

        <a class="login-link" asp-page="/Login">Already have an account? Login</a>
    </form>
</div>

<script>
document.getElementById('registerForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const passwd = document.getElementById('passwd').value;
    const passwdConfirm = document.getElementById('passwdConfirm').value;
    const errorContainer = document.getElementById('errorContainer');
    errorContainer.innerHTML = '';

    if (passwd !== passwdConfirm) {
        errorContainer.innerHTML = `<div class="alert">Passwords do not match</div>`;
        return;
    }
    if (passwd.length < 6) {
        errorContainer.innerHTML = `<div class="alert">Password must be at least 6 characters</div>`;
        return;
    }

    const formData = new FormData(this);
    formData.delete('passwdConfirm');

    try {
        const res = await fetch('/api/registration/register', { method: 'POST', body: formData });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();

        if (data.success) {
            window.location.href = '/Login?registered=true';
        } else {
            errorContainer.innerHTML = `<div class="alert">${data.error || 'Registration failed'}</div>`;
        }
    } catch (err) {
        errorContainer.innerHTML = `<div class="alert">Error registering. Please try again.</div>`;
    }
});
</script>
